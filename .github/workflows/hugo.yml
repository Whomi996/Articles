name: Deploy Hugo site to Pages

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v0.125.7/hugo_extended_0.125.7_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Install theme
        run: git clone --depth 1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod

      - name: Create Hugo config
        run: |
          cat > config.yml <<EOL
          baseURL: 'https://whomi996.github.io/Articles/'
          languageCode: zh-cn
          title: Articles
          theme: PaperMod
          
          enableRobotsTXT: true
          buildDrafts: false
          buildFuture: false
          buildExpired: false
          
          minify:
            disableXML: true
            minifyOutput: true
            
          params:
            env: production
            title: Articles
            description: "ä¸ªäººæ–‡ç« æ”¶é›†"
            keywords: [Blog, Portfolio, Articles]
            author: whomi996
            DateFormat: "2006-01-02"
            defaultTheme: auto
            ShowReadingTime: true
            ShowShareButtons: true
            ShowPostNavLinks: true
            ShowBreadCrumbs: true
            ShowCodeCopyButtons: true
            ShowWordCount: true
            ShowRssButtonInSectionTermList: true
            UseHugoToc: true
            disableSpecial1stPost: false
            disableScrollToTop: false
            comments: false
            hidemeta: false
            hideSummary: false
            showtoc: true
            tocopen: false
            
            assets:
              disableHLJS: true
              favicon: "<link / abs url>"
              favicon16x16: "<link / abs url>"
              favicon32x32: "<link / abs url>"
              apple_touch_icon: "<link / abs url>"
              safari_pinned_tab: "<link / abs url>"
              
            label:
              text: "Home"
              iconHeight: 35
              
            profileMode:
              enabled: false
              title: Articles
              imageUrl: "#"
              imageTitle: my image
              
            homeInfoParams:
              Title: "Hi there ðŸ‘‹"
              Content: Welcome to my blog
              
            socialIcons:
              - name: github
                url: "https://github.com/whomi996"
                
            cover:
              hidden: false
              hiddenInList: false
              hiddenInSingle: false
              
            editPost:
              URL: "https://github.com/whomi996/Articles/content"
              Text: "Suggest Changes"
              appendFilePath: true
            
          menu:
            main:
              - identifier: archives
                name: å½’æ¡£
                url: /archives/
                weight: 10
              - identifier: categories
                name: åˆ†ç±»
                url: /categories/
                weight: 20
              - identifier: tags
                name: æ ‡ç­¾
                url: /tags/
                weight: 30
              - identifier: search
                name: æœç´¢
                url: /search/
                weight: 40
                
          # for search
          outputs:
            home:
              - HTML
              - RSS
              - JSON
              
          markup:
            highlight:
              noClasses: false
              anchorLineNos: true
              codeFences: true
              guessSyntax: true
              lineNos: true
              style: monokai
          EOL

      - name: Setup content structure
        run: |
          mkdir -p content/posts
          mkdir -p content/search
          
          # åˆ›å»ºæœç´¢é¡µå’Œå½’æ¡£é¡µ
          cat > content/search.md <<EOL
          ---
          title: "æœç´¢" 
          layout: "search"
          ---
          EOL
          
          cat > content/archives.md <<EOL
          ---
          title: "å½’æ¡£"
          layout: "archives"
          url: "/archives"
          summary: archives
          ---
          EOL
          
          # å¤„ç† Markdown æ–‡ä»¶
          find . -name "*.md" -not -path "./themes/*" -not -path "./archetypes/*" -not -path "./content/*" | while read file; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              if [ "$filename" = "README.md" ]; then
                continue
              fi
              
              dir_path=$(dirname "$file")
              category=$(basename "$dir_path")
              
              if [ "$dir_path" = "." ]; then
                target="content/posts/$filename"
                category="æœªåˆ†ç±»"
              else
                target="content/posts/${category}/$filename"
                mkdir -p "content/posts/${category}"
              fi
              
              # æ·»åŠ æˆ–æ›´æ–° front matter
              if ! grep -q "^---" "$file"; then
                title=$(basename "$file" .md)
                date=$(git log -1 --format=%aI -- "$file")
                temp_file=$(mktemp)
                echo "---" > "$temp_file"
                echo "title: \"$title\"" >> "$temp_file"
                echo "date: $date" >> "$temp_file"
                echo "draft: false" >> "$temp_file"
                echo "categories: [\"$category\"]" >> "$temp_file"
                # æ ¹æ®æ–‡ä»¶å¤¹åæ·»åŠ æ ‡ç­¾
                case "$category" in
                  "github")
                    echo "tags: [\"GitHub\", \"å·¥ä½œæµ\"]" >> "$temp_file"
                    ;;
                  "ä»Ž0å¼€å§‹åšå¢žé•¿")
                    echo "tags: [\"å¢žé•¿\", \"è¥é”€\", \"å­¦ä¹ ç¬”è®°\"]" >> "$temp_file"
                    ;;
                  "AIå¤§æ¨¡åž‹å®žæˆ˜ç«¯æ‰‹è¯¾")
                    echo "tags: [\"AI\", \"å¤§æ¨¡åž‹\", \"å®žæˆ˜\"]" >> "$temp_file"
                    ;;
                  *)
                    echo "tags: []" >> "$temp_file"
                    ;;
                esac
                echo "---" >> "$temp_file"
                cat "$file" >> "$temp_file"
                mv "$temp_file" "$target"
              else
                # å¦‚æžœå·²æœ‰ front matterï¼Œä¿ç•™åŽŸæœ‰çš„å¹¶æ·»åŠ åˆ†ç±»
                temp_file=$(mktemp)
                awk '
                  BEGIN {front_matter=0; categories_added=0; tags_added=0}
                  /^---/ {
                    if (front_matter == 0) {
                      front_matter=1
                      print "---"
                      next
                    }
                  }
                  front_matter == 1 && !categories_added && !/^categories:/ && !/^---/ {
                    printf "categories: [\"%s\"]\n", "'$category'"
                    categories_added=1
                  }
                  {print}
                ' "$file" > "$temp_file"
                mv "$temp_file" "$target"
              fi
            fi
          done

      - name: Build with Hugo
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
        run: hugo --minify

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
